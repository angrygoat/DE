# Managed by Ansible. Manual customizations may be overwritten.

*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]

-A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT
-A INPUT -p icmp -j ACCEPT
-A INPUT -i lo -j ACCEPT

# all: SSH from DMZ and Trust
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.dmz }} --dport 22 -j ACCEPT
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.trust }} --dport 22 -j ACCEPT

{% if inventory_hostname in groups['amqp-brokers'] %}
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.dmz }} --dport {{ amqp_broker.port }} -j ACCEPT
{% endif %}

{% if inventory_hostname in groups['cas'] %}
# allow CAS/LDAP ports from DMZ
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.dmz }} --dport 80 -j ACCEPT
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.dmz }} --dport 389 -j ACCEPT
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.dmz }} --dport 443 -j ACCEPT
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.dmz }} --dport 8443 -j ACCEPT
{% endif %}

{% if inventory_hostname in groups['condor'] %}
# condor ports from DMZ
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.dmz }} --dport 61440:65535 -j ACCEPT
-A INPUT -m state --state NEW -m udp -p udp -s {{ net.dmz }} --dport 61440:65535 -j ACCEPT
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.dmz }} --dport 9618 -j ACCEPT
{% endif %}

{% if inventory_hostname in groups['condor-submission'] %}
# condor-submission range from DMZ (until we pick a condor_shared_port)
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.dmz }} -j ACCEPT
-A INPUT -m state --state NEW -m udp -p udp -s {{ net.dmz }} -j ACCEPT
{% endif %}

{% if inventory_hostname in groups['dataverse'] %}
# Glassfish / DVN
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.campus }} --dport 80 -j ACCEPT
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.wifi }} --dport 80 -j ACCEPT
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.campus }} --dport 443 -j ACCEPT
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.wifi }} --dport 443 -j ACCEPT

# Glassfish Console
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.dmz }} --dport 4848 -j ACCEPT
{% endif %}

{% if inventory_hostname in groups['db'] %}
# postgres from DMZ
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.dmz }} --dport {{ db_port }} -j ACCEPT
{% endif %}

{% if inventory_hostname in groups['docker-registry'] %}
# docker-registry ports from DMZ
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.dmz }} --dport {{ docker.registry.port }} -j ACCEPT
-A INPUT -m state --state NEW -m udp -p udp -s {{ net.dmz }} --dport {{ docker.registry.port }} -j ACCEPT
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.trust }} --dport {{ docker.registry.port }} -j ACCEPT
-A INPUT -m state --state NEW -m udp -p udp -s {{ net.trust }} --dport {{ docker.registry.port }} -j ACCEPT
{% endif %}

{% if inventory_hostname in groups['irods'] %}
# irods from DMZ and Trust
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.dmz }} --dport 1247 -j ACCEPT
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.dmz }} --dport 20000:20199 -j ACCEPT
-A INPUT -m state --state NEW -m udp -p udp -s {{ net.dmz }} --dport 20000:20199 -j ACCEPT
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.trust }} --dport 1247 -j ACCEPT
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.trust }} --dport 20000:20199 -j ACCEPT
-A INPUT -m state --state NEW -m udp -p udp -s {{ net.trust }} --dport 20000:20199 -j ACCEPT
{% endif %}

{% if inventory_hostname in groups['rserve'] %}
# rserve from DMZ
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.dmz }} --dport 6311 -j ACCEPT
{% endif %}

{% if inventory_hostname in groups['services'] %}
# service port range from DMZ
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.dmz }} --dport 31300:31399 -j ACCEPT
{% endif %}


{% if inventory_hostname in groups['docker-registry'] %}
# service port range for docker registry
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.dmz }} --dport 5000 -j ACCEPT
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.trust }} --dport 5000 -j ACCEPT

{% endif %}


{% if inventory_hostname in groups['terrain'] %}
# terrain port from DMZ
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.dmz }} --dport {{ terrain.port }} -j ACCEPT
{% endif %}


xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
{% if inventory_hostname in groups['data-info'] %}
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.dmz }} --dport {{ terrain.port }} -j ACCEPT
{% endif %}


{% if inventory_hostname in groups['iplant-email'] %}
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.dmz }} --dport {{ iplant_email.port }} -j ACCEPT
{% endif %}


{% if inventory_hostname in groups['anon-files'] %}
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.dmz }} --dport {{ terrain.port }} -j ACCEPT
{% endif %}


{% if inventory_hostname in groups['apps'] %}
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.dmz }} --dport {{ apps.port }} -j ACCEPT
{% endif %}


{% if inventory_hostname in groups['elasticsearch'] %}
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.dmz }} --dport {{ elasticsearch.port }} -j ACCEPT
{% endif %}


{% if inventory_hostname in groups['iplant-groups'] %}
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.dmz }} --dport {{ iplant_groups.port }} -j ACCEPT
{% endif %}


{% if inventory_hostname in groups['jex'] %}
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.dmz }} --dport {{ jex.port }} -j ACCEPT
{% endif %}


{% if inventory_hostname in groups['jexevents'] %}
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.dmz }} --dport {{ jexevents.port }} -j ACCEPT
{% endif %}

{% if inventory_hostname in groups['kifshare'] %}
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.dmz }} --dport {{ kifshare.port }} -j ACCEPT
{% endif %}


{% if inventory_hostname in groups['metadata'] %}
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.dmz }} --dport {{ metadata.port }} -j ACCEPT
{% endif %}

{% if inventory_hostname in groups['notificationagent'] %}
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.dmz }} --dport {{ notificationagent.port }} -j ACCEPT
{% endif %}

{% if inventory_hostname in groups['saved-searches'] %}
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.dmz }} --dport {{ saved_searches.port }} -j ACCEPT
{% endif %}

{% if inventory_hostname in groups['tree-urls'] %}
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.dmz }} --dport {{ tree_urls.port }} -j ACCEPT
{% endif %}


{% if inventory_hostname in groups['user-preferences'] %}
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.dmz }} --dport {{ user_preferences.port }} -j ACCEPT
{% endif %}

{% if inventory_hostname in groups['ui'] %}
# http and https, campus for now
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.campus }} --dport 80 -j ACCEPT
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.vpn }} --dport 80 -j ACCEPT
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.wifi }} --dport 80 -j ACCEPT
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.dmz }} --dport 389 -j ACCEPT
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.trust }} --dport 389 -j ACCEPT
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.campus }} --dport 443 -j ACCEPT
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.vpn }} --dport 443 -j ACCEPT
-A INPUT -m state --state NEW -m tcp -p tcp -s {{ net.wifi }} --dport 443 -j ACCEPT
{% endif %}

-A INPUT -j REJECT --reject-with icmp-host-prohibited
-A FORWARD -j REJECT --reject-with icmp-host-prohibited
COMMIT
